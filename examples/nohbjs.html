<script>
var utf8Encoder = new TextEncoder("utf8");

// We could use instantiateStreaming but it's not supported in Safari yet
// https://bugs.webkit.org/show_bug.cgi?id=173105
fetch("../hb.wasm").then(function (x) {
  return x.arrayBuffer();
}).then(function (wasm) {
  return WebAssembly.instantiate(wasm);
}).then(function (result) {
  var exports = result.instance.exports;

  fetch('Roboto.abc.ttf').then(function (x) {
    return x.arrayBuffer();
  }).then(function (fontBlob) {
    var heapu8 = new Uint8Array(exports.memory.buffer);
    var heapu32 = new Uint32Array(exports.memory.buffer);
    var heapi32 = new Int32Array(exports.memory.buffer);

    var fontBuffer = exports.malloc(fontBlob.byteLength);
    heapu8.set(new Uint8Array(fontBlob), fontBuffer);

    var blob = exports.hb_blob_create(fontBuffer, fontBlob.byteLength, 2/*HB_MEMORY_MODE_WRITABLE*/, 0, 0);
    var face = exports.hb_face_create(blob, 0);
    var font = exports.hb_font_create(face);

    var buffer = exports.hb_buffer_create();
    {
      var text = utf8Encoder.encode('abc');
      var text_ptr = exports.malloc(text.byteLength);
      heapu8.set(text, text_ptr);
      exports.hb_buffer_add_utf8(buffer, text_ptr, text.byteLength, 0, -1);
      exports.free(text_ptr);
    }
    exports.hb_buffer_guess_segment_properties(buffer);
    // exports.hb_buffer_set_direction(5); 4: ltr, 5: rtl, 6: ttb. 7: btt

    exports.hb_shape(font, buffer, 0, 0);

    var length = exports.hb_buffer_get_length(buffer);
    var result = [];
